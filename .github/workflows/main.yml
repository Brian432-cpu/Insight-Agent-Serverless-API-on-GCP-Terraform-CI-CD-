name: CI/CD - Build & Deploy


on:
push:
branches: [ main ]


permissions:
contents: read
id-token: write


jobs:
build-and-deploy:
runs-on: ubuntu-latest
env:
PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
REGION: us-central1
LOCATION: us-central1
ARTIFACT_REPO: insight-agent-repo


steps:
- name: Checkout
uses: actions/checkout@v4


- name: Set up Python
uses: actions/setup-python@v4
with:
python-version: '3.11'


- name: Lint (optional)
run: |
python -m pip install --upgrade pip
pip install flake8
flake8 app || true


- name: Set up gcloud CLI
uses: google-github-actions/setup-gcloud@v1
with:
version: '438.0.0'
service_account_key: ${{ secrets.GCP_SA_KEY }}
project_id: ${{ secrets.GCP_PROJECT_ID }}


- name: Configure Docker for Artifact Registry
run: |
gcloud auth configure-docker ${LOCATION}-docker.pkg.dev --quiet


- name: Build Docker image
run: |
IMAGE="${{ secrets.GCP_PROJECT_ID }}-${{ env.LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/$ARTIFACT_REPO/insight-agent:${{ github.sha }}"
docker build -t $IMAGE ./app
echo "IMAGE=$IMAGE" >> $GITHUB_ENV


- name: Push Docker image to Artifact Registry
run: |
docker push $IMAGE


- name: Prepare Terraform
uses: hashicorp/setup-terraform@v2
with:
terraform_version: 1.5.7


- name: Copy SA key for Terraform
run: |
echo "${{ secrets.GCP_SA_KEY }}" > terraform/terraform-sa.json


- name: Terraform Init
working-directory: ./terraform
run: |
terraform init -input=false


- name: Terraform Apply
working-directory: ./terraform
env:
rm -f terraform/terraform-sa.json
